<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·∫•u H√¨nh Telegram Bot</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .config-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .config-header {
            text-align: center;
            margin-bottom: 30px;
            color: #8B4513;
        }
        .config-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-group label {
            font-weight: 600;
            color: #333;
        }
        .form-group input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }
        .form-group small {
            color: #666;
            font-size: 0.9em;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #8B4513;
            color: white;
        }
        .btn-primary:hover {
            background: #A0522D;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .status-info {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .status-info.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-info.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #8B4513;
            text-decoration: none;
            font-weight: 600;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .chat-id-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .chat-id-item input {
            flex: 1;
        }
        .chat-id-item button {
            padding: 12px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        .chat-id-item button:hover {
            background: #c82333;
        }
        .btn-test {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        .btn-test:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn-test:active {
            transform: translateY(0);
        }
        #testResults {
            border-top: 2px solid #17a2b8;
            padding-top: 15px;
        }
        .test-result-item {
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 4px solid #17a2b8;
            background: #f8f9fa;
        }
        .test-result-item.success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .test-result-item.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="config-container">
        <a href="index.html" class="back-link">‚Üê V·ªÅ trang ch·ªß</a>
        
        <div class="config-header">
            <h1>ü§ñ C·∫•u H√¨nh Telegram Bot</h1>
            <p>Thi·∫øt l·∫≠p bot ƒë·ªÉ nh·∫≠n th√¥ng b√°o qua Telegram</p>
        </div>

        <div id="statusMessage" style="display: none;"></div>

        <form id="telegramConfigForm" class="config-form">
            <div class="form-group">
                <label for="botToken">Bot Token <span style="color: red;">*</span></label>
                <input type="text" id="botToken" name="botToken" required 
                       placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz">
                <small>
                    L·∫•y Bot Token t·ª´ <a href="https://t.me/BotFather" target="_blank">@BotFather</a> tr√™n Telegram
                </small>
            </div>

            <div class="form-group">
                <label>Chat IDs (Nh√≥m/C√° nh√¢n) <span style="color: red;">*</span></label>
                <div id="chatIdsContainer">
                    <!-- Chat IDs s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông ·ªü ƒë√¢y -->
                </div>
                <button type="button" id="addChatIdBtn" class="btn btn-secondary" style="margin-top: 10px;">
                    + Th√™m Chat ID
                </button>
                <small>
                    Chat ID c·ªßa b·∫°n ho·∫∑c nh√≥m. ƒê·ªÉ l·∫•y Chat ID, g·ª≠i tin nh·∫Øn cho bot <a href="https://t.me/userinfobot" target="_blank">@userinfobot</a> ho·∫∑c th√™m bot v√†o nh√≥m v√† g·ª≠i tin nh·∫Øn b·∫•t k·ª≥, sau ƒë√≥ truy c·∫≠p: https://api.telegram.org/bot&lt;YOUR_BOT_TOKEN&gt;/getUpdates
                </small>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="testModeCheckbox" style="width: 20px; height: 20px; cursor: pointer;">
                    <span><strong>üß™ Ch·∫ø ƒë·ªô Test</strong> (Ch·ªâ m√¥ ph·ªèng, kh√¥ng g·ª≠i th√¥ng b√°o th·∫≠t)</span>
                </label>
                <small style="margin-left: 30px; color: #666;">
                    Khi b·∫≠t ch·∫ø ƒë·ªô test, h·ªá th·ªëng s·∫Ω ch·ªâ log th√¥ng b√°o v√†o console, kh√¥ng g·ª≠i th·∫≠t qua Telegram. H·ªØu √≠ch ƒë·ªÉ ki·ªÉm tra format th√¥ng b√°o.
                </small>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn btn-primary">L∆∞u C·∫•u H√¨nh</button>
                <button type="button" class="btn btn-secondary" id="testBtn">Ki·ªÉm Tra K·∫øt N·ªëi</button>
                <button type="button" class="btn btn-secondary" id="autoConfigBtn" style="background: #28a745;">‚ö° T·ª± ƒê·ªông C·∫•u H√¨nh</button>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 4px; border-left: 4px solid #ffc107;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="autoTestCheckbox" style="margin-right: 8px; width: 18px; height: 18px;">
                    <span><strong>ü§ñ T·ª± ƒë·ªông test sau khi l∆∞u c·∫•u h√¨nh</strong></span>
                </label>
                <small style="display: block; margin-top: 5px; color: #856404;">
                    Khi b·∫≠t, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ch·∫°y test to√†n b·ªô API sau khi l∆∞u c·∫•u h√¨nh th√†nh c√¥ng.
                </small>
            </div>

            <!-- Khu v·ª±c test -->
            <div style="margin-top: 30px; padding: 20px; background: #e7f3ff; border-radius: 8px; border: 2px solid #17a2b8;">
                <h3 style="margin-top: 0; color: #17a2b8; display: flex; align-items: center; gap: 10px;">
                    üß™ Khu V·ª±c Test
                </h3>
                <p style="color: #666; margin-bottom: 15px;">
                    Test c√°c lo·∫°i th√¥ng b√°o kh√°c nhau. <strong>L∆∞u √Ω:</strong> B·∫≠t ch·∫ø ƒë·ªô test ·ªü tr√™n ƒë·ªÉ kh√¥ng g·ª≠i th√¥ng b√°o th·∫≠t.
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                    <button type="button" class="btn-test" data-test="appointment" style="background: #28a745;">
                        üìÖ Test ƒêƒÉng K√Ω L·ªãch H·∫πn
                    </button>
                    <button type="button" class="btn-test" data-test="ubnd" style="background: #17a2b8;">
                        üèõÔ∏è Test ƒêƒÉng K√Ω UBND
                    </button>
                    <button type="button" class="btn-test" data-test="bank" style="background: #ffc107; color: #333;">
                        üè¶ Test ƒê·ªìng B·ªô Ng√¢n H√†ng
                    </button>
                    <button type="button" class="btn-test" data-test="delete" style="background: #dc3545;">
                        üóëÔ∏è Test X√≥a ƒêƒÉng K√Ω
                    </button>
                    <button type="button" class="btn-test" data-test="clearAll" style="background: #6c757d;">
                        üóëÔ∏è Test X√≥a T·∫•t C·∫£
                    </button>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                    <button type="button" class="btn btn-secondary" id="testAllBtn" style="flex: 1; min-width: 200px; background: #17a2b8;">
                        üß™ Test T·∫•t C·∫£ C√°c Lo·∫°i Th√¥ng B√°o
                    </button>
                    <button type="button" class="btn btn-secondary" id="testAllAPIBtn" style="flex: 1; min-width: 200px; background: #6f42c1;">
                        üî¨ Test To√†n B·ªô API
                    </button>
                    <button type="button" class="btn btn-secondary" id="autoTestBtn" style="flex: 1; min-width: 200px; background: #20c997;">
                        ü§ñ T·ª± ƒê·ªông Test Ngay
                    </button>
                </div>

                <!-- K·∫øt qu·∫£ test -->
                <div id="testResults" style="margin-top: 20px; display: none;">
                    <h4 style="color: #17a2b8; margin-bottom: 10px;">üìä K·∫øt Qu·∫£ Test:</h4>
                    <div id="testResultsContent" style="background: white; padding: 15px; border-radius: 4px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em;"></div>
                </div>
            </div>
        </form>

        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 4px;">
            <h3 style="margin-top: 0; color: #8B4513;">üìñ H∆∞·ªõng D·∫´n Nhanh</h3>
            <ol style="line-height: 1.8; color: #666;">
                <li><strong>T·∫°o Bot:</strong> Chat v·ªõi <a href="https://t.me/BotFather" target="_blank">@BotFather</a>, g·ª≠i <code>/newbot</code> v√† l√†m theo h∆∞·ªõng d·∫´n</li>
                <li><strong>L·∫•y Bot Token:</strong> Sao ch√©p token t·ª´ BotFather v√† d√°n v√†o √¥ "Bot Token"</li>
                <li><strong>L·∫•y Chat ID c√° nh√¢n:</strong> Chat v·ªõi <a href="https://t.me/userinfobot" target="_blank">@userinfobot</a> ƒë·ªÉ xem Chat ID c·ªßa b·∫°n</li>
                <li><strong>L·∫•y Chat ID nh√≥m:</strong> 
                    <ul style="margin-top: 5px; padding-left: 20px;">
                        <li>Th√™m bot v√†o nh√≥m</li>
                        <li>G·ª≠i tin nh·∫Øn b·∫•t k·ª≥ trong nh√≥m</li>
                        <li>Truy c·∫≠p: <code>https://api.telegram.org/bot&lt;YOUR_BOT_TOKEN&gt;/getUpdates</code></li>
                        <li>T√¨m <code>"chat":{"id":-1001234567890}</code> (s·ªë √¢m l√† Chat ID nh√≥m)</li>
                    </ul>
                </li>
                <li><strong>Th√™m nhi·ªÅu Chat ID:</strong> Nh·∫•n n√∫t "+ Th√™m Chat ID" ƒë·ªÉ th√™m Chat ID kh√°c (c√° nh√¢n ho·∫∑c nh√≥m)</li>
                <li><strong>Ki·ªÉm tra:</strong> Nh·∫•n "Ki·ªÉm Tra K·∫øt N·ªëi" ƒë·ªÉ g·ª≠i tin nh·∫Øn test</li>
                <li><strong>L∆∞u:</strong> Nh·∫•n "L∆∞u C·∫•u H√¨nh" ƒë·ªÉ ho√†n t·∫•t</li>
            </ol>
            <p style="margin-top: 15px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; color: #856404;">
                <strong>üí° L∆∞u √Ω:</strong> Chat ID nh√≥m th∆∞·ªùng b·∫Øt ƒë·∫ßu b·∫±ng <code>-100</code> (s·ªë √¢m). ƒê·∫£m b·∫£o bot ƒë√£ ƒë∆∞·ª£c th√™m v√†o nh√≥m v√† c√≥ quy·ªÅn g·ª≠i tin nh·∫Øn.
            </p>
            <p style="margin-top: 10px;">
                <a href="HUONG_DAN_TELEGRAM_BOT.md" target="_blank" style="color: #8B4513; font-weight: 600; text-decoration: underline;">
                    üìÑ Xem h∆∞·ªõng d·∫´n chi ti·∫øt (file HUONG_DAN_TELEGRAM_BOT.md)
                </a>
            </p>
        </div>
    </div>

    <script src="telegram-bot.js"></script>
    <script>
            // H√†m t·ª± ƒë·ªông test
            async function runAutoTest() {
                // ƒê·∫£m b·∫£o test mode ƒë∆∞·ª£c b·∫≠t ƒë·ªÉ kh√¥ng g·ª≠i th√¥ng b√°o th·∫≠t
                const testModeCheckbox = document.getElementById('testModeCheckbox');
                if (!testModeCheckbox.checked) {
                    testModeCheckbox.checked = true;
                    if (window.TelegramBot && window.TelegramBot.setTestMode) {
                        window.TelegramBot.setTestMode(true);
                    }
                }
                
                // Ch·∫°y test to√†n b·ªô API
                if (window.TelegramBot && window.TelegramBot.testAllAPI) {
                    try {
                        const result = await window.TelegramBot.testAllAPI();
                        
                        if (result.success) {
                            showStatus(`‚úÖ [T·ª∞ ƒê·ªòNG TEST] Ho√†n th√†nh! ${result.totalPassed}/${result.totalTests} test passed (${result.successRate}%)`, 'success');
                            
                            let resultsHtml = `<div class="test-result-item success"><strong>‚úÖ T·ª± ƒê·ªông Test - Ho√†n Th√†nh</strong></div>`;
                            resultsHtml += `<div style="margin: 10px 0; padding: 10px; background: #d4edda; border-radius: 4px;">`;
                            resultsHtml += `<strong>üìä T·ªïng K·∫øt:</strong><br>`;
                            resultsHtml += `‚úÖ Passed: ${result.totalPassed}/${result.totalTests}<br>`;
                            resultsHtml += `‚ùå Failed: ${result.totalFailed}/${result.totalTests}<br>`;
                            resultsHtml += `üìà T·ª∑ l·ªá th√†nh c√¥ng: ${result.successRate}%<br>`;
                            resultsHtml += `</div>`;
                            
                            resultsHtml += `<div style="margin-top: 10px;"><strong>üìã Chi Ti·∫øt:</strong></div>`;
                            resultsHtml += `<div style="margin: 5px 0;">1. C·∫•u h√¨nh: ${result.details.config.passed}/${result.details.config.passed + result.details.config.failed} passed</div>`;
                            resultsHtml += `<div style="margin: 5px 0;">2. Format message: ${result.details.formatting.passed}/${result.details.formatting.passed + result.details.formatting.failed} passed</div>`;
                            resultsHtml += `<div style="margin: 5px 0;">3. Qu·∫£n l√Ω Chat ID: ${result.details.chatIdManagement.passed}/${result.details.chatIdManagement.passed + result.details.chatIdManagement.failed} passed</div>`;
                            resultsHtml += `<div style="margin: 5px 0;">4. G·ª≠i tin nh·∫Øn: ${result.details.messaging.passed}/${result.details.messaging.passed + result.details.messaging.failed} passed</div>`;
                            resultsHtml += `<div style="margin: 5px 0;">5. Th√¥ng b√°o: ${result.details.notifications.passed}/${result.details.notifications.passed + result.details.notifications.failed} passed</div>`;
                            
                            resultsHtml += `<div style="margin-top: 10px; padding: 10px; background: #d1ecf1; border-radius: 4px;"><strong>üí° L∆∞u √Ω:</strong> Ki·ªÉm tra Console (F12) ƒë·ªÉ xem chi ti·∫øt t·ª´ng test case.</div>`;
                            
                            showTestResults(resultsHtml, 'success');
                        } else {
                            showStatus(`‚ö†Ô∏è [T·ª∞ ƒê·ªòNG TEST] C√≥ ${result.totalFailed} test failed. Ki·ªÉm tra Console ƒë·ªÉ xem chi ti·∫øt.`, 'error');
                            
                            let resultsHtml = `<div class="test-result-item error"><strong>‚ö†Ô∏è T·ª± ƒê·ªông Test - C√≥ L·ªói</strong></div>`;
                            resultsHtml += `<div style="margin: 10px 0; padding: 10px; background: #f8d7da; border-radius: 4px;">`;
                            resultsHtml += `<strong>üìä T·ªïng K·∫øt:</strong><br>`;
                            resultsHtml += `‚úÖ Passed: ${result.totalPassed}/${result.totalTests}<br>`;
                            resultsHtml += `‚ùå Failed: ${result.totalFailed}/${result.totalTests}<br>`;
                            resultsHtml += `üìà T·ª∑ l·ªá th√†nh c√¥ng: ${result.successRate}%<br>`;
                            resultsHtml += `</div>`;
                            resultsHtml += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px;"><strong>üí° L∆∞u √Ω:</strong> Ki·ªÉm tra Console (F12) ƒë·ªÉ xem chi ti·∫øt c√°c l·ªói.</div>`;
                            
                            showTestResults(resultsHtml, 'error');
                        }
                    } catch (error) {
                        showStatus(`‚ùå [T·ª∞ ƒê·ªòNG TEST] L·ªói: ${error.message}`, 'error');
                        showTestResults(`<div class="test-result-item error"><strong>‚ùå L·ªói:</strong> ${error.message}</div>`, 'error');
                    }
                } else {
                    showStatus('L·ªói: H√†m testAllAPI kh√¥ng kh·∫£ d·ª•ng. Vui l√≤ng ki·ªÉm tra l·∫°i file telegram-bot.js', 'error');
                }
            }

            // H√†m t·ª± ƒë·ªông c·∫•u h√¨nh token v√† chat ID
            function autoConfigureTelegram() {
                const defaultToken = '7699871995:AAErjz_8XGMLWHO05xVz3UqLUsGHny9_e2M';
                const defaultChatId = '-1003488821832';
                
                // ƒêi·ªÅn token
                document.getElementById('botToken').value = defaultToken;
                
                // X√≥a c√°c chat ID c≈© v√† th√™m chat ID m·ªõi
                const chatIdContainer = document.getElementById('chatIdsContainer');
                chatIdContainer.innerHTML = '';
                addChatIdInput(defaultChatId);
                
                showStatus('‚úÖ ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn Token v√† Chat ID! Vui l√≤ng nh·∫•n "L∆∞u C·∫•u H√¨nh" ƒë·ªÉ l∆∞u.', 'success');
            }

            // Load c·∫•u h√¨nh hi·ªán t·∫°i
            document.addEventListener('DOMContentLoaded', function() {
                const config = window.TelegramBot ? window.TelegramBot.getTelegramConfig() : null;
                
                // Ki·ªÉm tra URL parameter ƒë·ªÉ xem c√≥ y√™u c·∫ßu auto setup kh√¥ng
                const urlParams = new URLSearchParams(window.location.search);
                const autoSetup = urlParams.get('autosetup');
                
                if (config) {
                    document.getElementById('botToken').value = config.botToken || '';
                    
                    // Load chat IDs (h·ªó tr·ª£ c·∫£ c·∫•u h√¨nh c≈© v√† m·ªõi)
                    const chatIds = config.chatIds || (config.chatId ? [config.chatId] : []);
                    renderChatIds(chatIds);
                    
                    // Load test mode
                    const testMode = window.TelegramBot ? window.TelegramBot.isTestMode() : false;
                    document.getElementById('testModeCheckbox').checked = testMode;
                    
                    // T·ª± ƒë·ªông test khi trang load n·∫øu ƒë√£ c√≥ c·∫•u h√¨nh h·ª£p l·ªá
                    if (window.TelegramBot && window.TelegramBot.isTelegramConfigured()) {
                        // Ki·ªÉm tra URL parameter ƒë·ªÉ xem c√≥ y√™u c·∫ßu auto test kh√¥ng
                        const autoTest = urlParams.get('autotest');
                        
                        if (autoTest === 'true' || autoTest === '1') {
                            // T·ª± ƒë·ªông test sau 2 gi√¢y ƒë·ªÉ ƒë·∫£m b·∫£o trang ƒë√£ load xong
                            setTimeout(async () => {
                                showStatus('ü§ñ T·ª± ƒë·ªông ch·∫°y test khi trang load...', 'info');
                                await runAutoTest();
                            }, 2000);
                        }
                    }
                } else {
                    // N·∫øu ch∆∞a c√≥ c·∫•u h√¨nh
                    if (autoSetup === 'true' || autoSetup === '1') {
                        // T·ª± ƒë·ªông c·∫•u h√¨nh v√† l∆∞u
                        setTimeout(() => {
                            if (window.TelegramBot && window.TelegramBot.autoSetupTelegram) {
                                window.TelegramBot.autoSetupTelegram();
                                autoConfigureTelegram();
                                showStatus('‚úÖ ƒê√£ t·ª± ƒë·ªông c·∫•u h√¨nh token v√† chat ID!', 'success');
                                
                                // T·ª± ƒë·ªông test sau khi c·∫•u h√¨nh
                                const autoTest = urlParams.get('autotest');
                                if (autoTest === 'true' || autoTest === '1') {
                                    setTimeout(async () => {
                                        showStatus('ü§ñ T·ª± ƒë·ªông ch·∫°y test sau khi c·∫•u h√¨nh...', 'info');
                                        await runAutoTest();
                                    }, 2000);
                                }
                            }
                        }, 500);
                    } else {
                        // N·∫øu kh√¥ng c√≥ y√™u c·∫ßu auto setup, ch·ªâ th√™m input m·∫∑c ƒë·ªãnh
                        renderChatIds(['']);
                    }
                }

            // X·ª≠ l√Ω n√∫t t·ª± ƒë·ªông c·∫•u h√¨nh
            document.getElementById('autoConfigBtn').addEventListener('click', function() {
                autoConfigureTelegram();
            });

            // X·ª≠ l√Ω n√∫t th√™m chat ID
            document.getElementById('addChatIdBtn').addEventListener('click', function() {
                addChatIdInput('');
            });

            // X·ª≠ l√Ω test mode checkbox
            document.getElementById('testModeCheckbox').addEventListener('change', function() {
                const testMode = this.checked;
                if (window.TelegramBot && window.TelegramBot.setTestMode) {
                    window.TelegramBot.setTestMode(testMode);
                    const status = testMode ? 'ƒë√£ b·∫≠t' : 'ƒë√£ t·∫Øt';
                    showStatus(`üß™ Ch·∫ø ƒë·ªô test ${status}`, testMode ? 'info' : 'success');
                }
            });

            // X·ª≠ l√Ω submit form
            document.getElementById('telegramConfigForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const botToken = document.getElementById('botToken').value.trim();
                const chatIds = getAllChatIds();

                if (!botToken) {
                    showStatus('Vui l√≤ng nh·∫≠p Bot Token!', 'error');
                    return;
                }

                if (chatIds.length === 0 || chatIds.every(id => !id.trim())) {
                    showStatus('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt Chat ID!', 'error');
                    return;
                }

                const testMode = document.getElementById('testModeCheckbox').checked;
                const autoTest = document.getElementById('autoTestCheckbox').checked;
                
                if (window.TelegramBot && window.TelegramBot.saveTelegramConfig) {
                    window.TelegramBot.saveTelegramConfig(botToken, chatIds, testMode);
                    const testModeText = testMode ? ' (Ch·∫ø ƒë·ªô Test: B·∫¨T)' : ' (Ch·∫ø ƒë·ªô Test: T·∫ÆT)';
                    showStatus(`ƒê√£ l∆∞u c·∫•u h√¨nh th√†nh c√¥ng! (${chatIds.length} Chat ID)${testModeText}`, 'success');
                    
                    // T·ª± ƒë·ªông test n·∫øu ƒë∆∞·ª£c b·∫≠t
                    if (autoTest) {
                        setTimeout(async () => {
                            showStatus('ü§ñ ƒêang t·ª± ƒë·ªông ch·∫°y test to√†n b·ªô API...', 'info');
                            await runAutoTest();
                        }, 1000);
                    }
                } else {
                    showStatus('L·ªói: Kh√¥ng th·ªÉ l∆∞u c·∫•u h√¨nh. Vui l√≤ng ki·ªÉm tra l·∫°i file telegram-bot.js', 'error');
                }
            });

            // X·ª≠ l√Ω n√∫t ki·ªÉm tra k·∫øt n·ªëi
            document.getElementById('testBtn').addEventListener('click', async function() {
                const botToken = document.getElementById('botToken').value.trim();
                const chatIds = getAllChatIds().filter(id => id.trim());

                if (!botToken) {
                    showStatus('Vui l√≤ng nh·∫≠p Bot Token!', 'error');
                    return;
                }

                if (chatIds.length === 0) {
                    showStatus('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt Chat ID!', 'error');
                    return;
                }

                const testMode = document.getElementById('testModeCheckbox').checked;
                
                // L∆∞u t·∫°m ƒë·ªÉ test
                if (window.TelegramBot && window.TelegramBot.saveTelegramConfig) {
                    window.TelegramBot.saveTelegramConfig(botToken, chatIds, testMode);
                }

                const testModeText = testMode ? ' (Ch·∫ø ƒë·ªô Test - kh√¥ng g·ª≠i th·∫≠t)' : '';
                showStatus(`ƒêang ki·ªÉm tra k·∫øt n·ªëi ƒë·∫øn ${chatIds.length} Chat ID${testModeText}...`, 'info');

                const testMessage = 'üß™ <b>Ki·ªÉm Tra K·∫øt N·ªëi</b>\n\nƒê√¢y l√† tin nh·∫Øn ki·ªÉm tra t·ª´ h·ªá th·ªëng ƒëƒÉng k√Ω l·ªãch h·∫πn.';
                
                if (window.TelegramBot && window.TelegramBot.sendTelegramMessage) {
                    const result = await window.TelegramBot.sendTelegramMessage(testMessage);
                    
                    if (result.success) {
                        if (result.testMode) {
                            showStatus(`üß™ [TEST MODE] M√¥ ph·ªèng th√†nh c√¥ng! ƒê√£ test ${result.total} Chat ID. Ki·ªÉm tra console ƒë·ªÉ xem chi ti·∫øt.`, 'info');
                            console.log('üìã [TEST MODE] Chi ti·∫øt k·∫øt qu·∫£:', result);
                        } else {
                            showStatus(`‚úÖ K·∫øt n·ªëi th√†nh c√¥ng! Bot ƒë√£ g·ª≠i tin nh·∫Øn ki·ªÉm tra ƒë·∫øn ${result.successCount}/${result.total} Chat ID.`, 'success');
                        }
                    } else {
                        showStatus('‚ùå K·∫øt n·ªëi th·∫•t b·∫°i: ' + (result.error || 'Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c l·ªói'), 'error');
                    }
                } else {
                    showStatus('L·ªói: Kh√¥ng th·ªÉ ki·ªÉm tra k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra l·∫°i file telegram-bot.js', 'error');
                }
            });

            // X·ª≠ l√Ω c√°c n√∫t test ri√™ng l·∫ª
            document.querySelectorAll('.btn-test').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const testType = this.getAttribute('data-test');
                    await runSingleTest(testType);
                });
            });

            // X·ª≠ l√Ω n√∫t test to√†n b·ªô API
            document.getElementById('testAllAPIBtn').addEventListener('click', async function() {
                const testMode = document.getElementById('testModeCheckbox').checked;
                
                if (!testMode) {
                    if (!confirm('‚ö†Ô∏è Ch·∫ø ƒë·ªô test ch∆∞a ƒë∆∞·ª£c b·∫≠t. B·∫°n c√≥ mu·ªën b·∫≠t ch·∫ø ƒë·ªô test v√† ti·∫øp t·ª•c? (S·∫Ω kh√¥ng g·ª≠i th√¥ng b√°o th·∫≠t)')) {
                        return;
                    }
                    document.getElementById('testModeCheckbox').checked = true;
                    if (window.TelegramBot && window.TelegramBot.setTestMode) {
                        window.TelegramBot.setTestMode(true);
                    }
                }

                showStatus('üî¨ ƒêang test to√†n b·ªô API... M·ªü Console (F12) ƒë·ªÉ xem chi ti·∫øt.', 'info');
                showTestResults('üî¨ ƒêang test to√†n b·ªô API Telegram Bot...\n\nKi·ªÉm tra Console (F12) ƒë·ªÉ xem k·∫øt qu·∫£ chi ti·∫øt.', 'info');

                if (window.TelegramBot && window.TelegramBot.testAllAPI) {
                    try {
                        const result = await window.TelegramBot.testAllAPI();
                        
                        if (result.success) {
                            showStatus(`‚úÖ [TEST API] Ho√†n th√†nh! ${result.totalPassed}/${result.totalTests} test passed (${result.successRate}%)`, 'success');
                            
                            // Hi·ªÉn th·ªã k·∫øt qu·∫£ chi ti·∫øt
                            let resultsHtml = `<div class="test-result-item success"><strong>‚úÖ Test To√†n B·ªô API - Ho√†n Th√†nh</strong></div>`;
                            resultsHtml += `<div style="margin: 10px 0; padding: 10px; background: #d4edda; border-radius: 4px;">`;
                            resultsHtml += `<strong>üìä T·ªïng K·∫øt:</strong><br>`;
                            resultsHtml += `‚úÖ Passed: ${result.totalPassed}/${result.totalTests}<br>`;
                            resultsHtml += `‚ùå Failed: ${result.totalFailed}/${result.totalTests}<br>`;
                            resultsHtml += `üìà T·ª∑ l·ªá th√†nh c√¥ng: ${result.successRate}%<br>`;
                            resultsHtml += `</div>`;
                            
                            resultsHtml += `<div style="margin-top: 10px;"><strong>üìã Chi Ti·∫øt:</strong></div>`;
                            resultsHtml += `<div style="margin: 5px 0;">1. C·∫•u h√¨nh: ${result.details.config.passed}/${result.details.config.passed + result.details.config.failed} passed</div>`;
                            resultsHtml += `<div style="margin: 5px 0;">2. Format message: ${result.details.formatting.passed}/${result.details.formatting.passed + result.details.formatting.failed} passed</div>`;
                            resultsHtml += `<div style="margin: 5px 0;">3. Qu·∫£n l√Ω Chat ID: ${result.details.chatIdManagement.passed}/${result.details.chatIdManagement.passed + result.details.chatIdManagement.failed} passed</div>`;
                            resultsHtml += `<div style="margin: 5px 0;">4. G·ª≠i tin nh·∫Øn: ${result.details.messaging.passed}/${result.details.messaging.passed + result.details.messaging.failed} passed</div>`;
                            resultsHtml += `<div style="margin: 5px 0;">5. Th√¥ng b√°o: ${result.details.notifications.passed}/${result.details.notifications.passed + result.details.notifications.failed} passed</div>`;
                            
                            resultsHtml += `<div style="margin-top: 10px; padding: 10px; background: #d1ecf1; border-radius: 4px;"><strong>üí° L∆∞u √Ω:</strong> Ki·ªÉm tra Console (F12) ƒë·ªÉ xem chi ti·∫øt t·ª´ng test case.</div>`;
                            
                            showTestResults(resultsHtml, 'success');
                        } else {
                            showStatus(`‚ö†Ô∏è [TEST API] C√≥ ${result.totalFailed} test failed. Ki·ªÉm tra Console ƒë·ªÉ xem chi ti·∫øt.`, 'error');
                            
                            let resultsHtml = `<div class="test-result-item error"><strong>‚ö†Ô∏è Test To√†n B·ªô API - C√≥ L·ªói</strong></div>`;
                            resultsHtml += `<div style="margin: 10px 0; padding: 10px; background: #f8d7da; border-radius: 4px;">`;
                            resultsHtml += `<strong>üìä T·ªïng K·∫øt:</strong><br>`;
                            resultsHtml += `‚úÖ Passed: ${result.totalPassed}/${result.totalTests}<br>`;
                            resultsHtml += `‚ùå Failed: ${result.totalFailed}/${result.totalTests}<br>`;
                            resultsHtml += `üìà T·ª∑ l·ªá th√†nh c√¥ng: ${result.successRate}%<br>`;
                            resultsHtml += `</div>`;
                            resultsHtml += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px;"><strong>üí° L∆∞u √Ω:</strong> Ki·ªÉm tra Console (F12) ƒë·ªÉ xem chi ti·∫øt c√°c l·ªói.</div>`;
                            
                            showTestResults(resultsHtml, 'error');
                        }
                    } catch (error) {
                        showStatus(`‚ùå [TEST API] L·ªói: ${error.message}`, 'error');
                        showTestResults(`<div class="test-result-item error"><strong>‚ùå L·ªói:</strong> ${error.message}</div>`, 'error');
                    }
                } else {
                    showStatus('L·ªói: H√†m testAllAPI kh√¥ng kh·∫£ d·ª•ng. Vui l√≤ng ki·ªÉm tra l·∫°i file telegram-bot.js', 'error');
                }
            });

            // X·ª≠ l√Ω n√∫t t·ª± ƒë·ªông test ngay
            document.getElementById('autoTestBtn').addEventListener('click', async function() {
                if (!window.TelegramBot || !window.TelegramBot.isTelegramConfigured()) {
                    showStatus('‚ö†Ô∏è Vui l√≤ng c·∫•u h√¨nh Bot Token v√† Chat ID tr∆∞·ªõc khi test!', 'error');
                    return;
                }
                
                await runAutoTest();
            });

            // X·ª≠ l√Ω n√∫t test t·∫•t c·∫£
            document.getElementById('testAllBtn').addEventListener('click', async function() {
                const testMode = document.getElementById('testModeCheckbox').checked;
                
                if (!testMode) {
                    if (!confirm('‚ö†Ô∏è Ch·∫ø ƒë·ªô test ch∆∞a ƒë∆∞·ª£c b·∫≠t. B·∫°n c√≥ mu·ªën b·∫≠t ch·∫ø ƒë·ªô test v√† ti·∫øp t·ª•c? (S·∫Ω kh√¥ng g·ª≠i th√¥ng b√°o th·∫≠t)')) {
                        return;
                    }
                    document.getElementById('testModeCheckbox').checked = true;
                    if (window.TelegramBot && window.TelegramBot.setTestMode) {
                        window.TelegramBot.setTestMode(true);
                    }
                }

                showStatus('üß™ ƒêang test t·∫•t c·∫£ c√°c lo·∫°i th√¥ng b√°o... M·ªü Console (F12) ƒë·ªÉ xem chi ti·∫øt.', 'info');
                showTestResults('ƒêang test t·∫•t c·∫£ c√°c lo·∫°i th√¥ng b√°o...', 'info');

                if (window.TelegramBot && window.TelegramBot.testAllNotifications) {
                    const result = await window.TelegramBot.testAllNotifications();
                    
                    if (result.success) {
                        showStatus('‚úÖ [TEST MODE] ƒê√£ ho√†n th√†nh test t·∫•t c·∫£ c√°c lo·∫°i th√¥ng b√°o!', 'success');
                        console.log('üìä [TEST MODE] K·∫øt qu·∫£ test:', result);
                        
                        // Hi·ªÉn th·ªã k·∫øt qu·∫£ chi ti·∫øt
                        let resultsHtml = '<div class="test-result-item success"><strong>‚úÖ Test T·∫•t C·∫£ - Th√†nh C√¥ng</strong></div>';
                        resultsHtml += '<div class="test-result-item success">üìÖ ƒêƒÉng k√Ω l·ªãch h·∫πn: ‚úÖ</div>';
                        resultsHtml += '<div class="test-result-item success">üèõÔ∏è ƒêƒÉng k√Ω UBND: ‚úÖ</div>';
                        resultsHtml += '<div class="test-result-item success">üè¶ ƒê·ªìng b·ªô ng√¢n h√†ng: ‚úÖ</div>';
                        resultsHtml += '<div class="test-result-item success">üóëÔ∏è X√≥a ƒëƒÉng k√Ω: ‚úÖ</div>';
                        resultsHtml += '<div class="test-result-item success">üóëÔ∏è X√≥a t·∫•t c·∫£: ‚úÖ</div>';
                        resultsHtml += '<div style="margin-top: 10px; padding: 10px; background: #d1ecf1; border-radius: 4px;"><strong>üí° L∆∞u √Ω:</strong> Ki·ªÉm tra Console (F12) ƒë·ªÉ xem n·ªôi dung chi ti·∫øt c·ªßa t·ª´ng th√¥ng b√°o.</div>';
                        showTestResults(resultsHtml, 'success');
                    } else {
                        showStatus('‚ùå [TEST MODE] C√≥ l·ªói khi test: ' + (result.error || 'Kh√¥ng x√°c ƒë·ªãnh'), 'error');
                        showTestResults(`<div class="test-result-item error"><strong>‚ùå L·ªói:</strong> ${result.error || 'Kh√¥ng x√°c ƒë·ªãnh'}</div>`, 'error');
                    }
                } else {
                    showStatus('L·ªói: H√†m testAllNotifications kh√¥ng kh·∫£ d·ª•ng. Vui l√≤ng ki·ªÉm tra l·∫°i file telegram-bot.js', 'error');
                }
            });

            // H√†m ch·∫°y test t·ª´ng lo·∫°i
            async function runSingleTest(testType) {
                const testMode = document.getElementById('testModeCheckbox').checked;
                
                if (!testMode) {
                    if (!confirm('‚ö†Ô∏è Ch·∫ø ƒë·ªô test ch∆∞a ƒë∆∞·ª£c b·∫≠t. B·∫°n c√≥ mu·ªën b·∫≠t ch·∫ø ƒë·ªô test v√† ti·∫øp t·ª•c? (S·∫Ω kh√¥ng g·ª≠i th√¥ng b√°o th·∫≠t)')) {
                        return;
                    }
                    document.getElementById('testModeCheckbox').checked = true;
                    if (window.TelegramBot && window.TelegramBot.setTestMode) {
                        window.TelegramBot.setTestMode(true);
                    }
                }

                if (!window.TelegramBot || !window.TelegramBot.isTelegramConfigured()) {
                    showStatus('‚ö†Ô∏è Vui l√≤ng c·∫•u h√¨nh Bot Token v√† Chat ID tr∆∞·ªõc khi test!', 'error');
                    return;
                }

                const testNames = {
                    'appointment': 'ƒêƒÉng K√Ω L·ªãch H·∫πn',
                    'ubnd': 'ƒêƒÉng K√Ω UBND',
                    'bank': 'ƒê·ªìng B·ªô Ng√¢n H√†ng',
                    'delete': 'X√≥a ƒêƒÉng K√Ω',
                    'clearAll': 'X√≥a T·∫•t C·∫£'
                };

                showStatus(`üß™ ƒêang test: ${testNames[testType]}...`, 'info');
                showTestResults(`ƒêang test: ${testNames[testType]}...`, 'info');

                try {
                    let result = null;
                    
                    if (testType === 'appointment') {
                        const testData = {
                            fullName: 'Nguy·ªÖn VƒÉn Test',
                            phone: '0912345678',
                            idNumber: '001234567890',
                            address: '123 ƒê∆∞·ªùng Test',
                            officer: 'C√°n b·ªô Test',
                            soBanNganh: 'UBND Ph∆∞·ªùng/X√£',
                            appointmentDate: new Date().toISOString().split('T')[0],
                            appointmentTime: '0800-0830',
                            jobType: 'ƒêƒÉng k√Ω khai sinh',
                            purpose: 'Test m·ª•c ƒë√≠ch',
                            participants: '1',
                            province: 'H√† N·ªôi',
                            ward: 'Ph∆∞·ªùng Test',
                            vnidLevel2: 'C√≥',
                            bankSync: 'C√≥'
                        };
                        result = await window.TelegramBot.notifyNewAppointment(testData);
                    } else if (testType === 'ubnd') {
                        const testData = {
                            fullName: 'Tr·∫ßn Th·ªã Test',
                            phone: '0987654321',
                            email: 'test@example.com',
                            idNumber: '001234567891',
                            address: '456 ƒê∆∞·ªùng Test',
                            organization: 'UBND Ph∆∞·ªùng/X√£',
                            officer: 'C√°n b·ªô Test',
                            appointmentDate: new Date().toISOString().split('T')[0],
                            timeSlot: '09:00 - 09:30',
                            jobType: 'ƒêƒÉng k√Ω k·∫øt h√¥n',
                            jobDescription: 'Test m√¥ t·∫£ c√¥ng vi·ªác',
                            participants: 2,
                            vneidLevel2: 'C√≥',
                            bankLinked: 'C√≥'
                        };
                        result = await window.TelegramBot.notifyNewUBNDAppointment(testData);
                    } else if (testType === 'bank') {
                        const testData = {
                            fullName: 'L√™ VƒÉn Test',
                            phone: '0901234567',
                            email: 'banktest@example.com',
                            idNumber: '001234567892',
                            bankName: 'Ng√¢n h√†ng Test',
                            bankBranch: 'Chi nh√°nh Test',
                            accountNumber: '1234567890',
                            accountHolderName: 'L√™ VƒÉn Test'
                        };
                        result = await window.TelegramBot.notifyNewBankSync(testData, 'TEST1234');
                    } else if (testType === 'delete') {
                        const testData = {
                            fullName: 'Nguy·ªÖn VƒÉn Test',
                            phone: '0912345678'
                        };
                        result = await window.TelegramBot.notifyDeleteAppointment(testData, 'appointment');
                    } else if (testType === 'clearAll') {
                        result = await window.TelegramBot.notifyClearAllAppointments(5, 'appointment');
                    }

                    if (result && (result.success || result.testMode)) {
                        showStatus(`‚úÖ [TEST] ${testNames[testType]} - Th√†nh c√¥ng!`, 'success');
                        showTestResults(
                            `<div class="test-result-item success">
                                <strong>‚úÖ ${testNames[testType]} - Th√†nh c√¥ng</strong><br>
                                <small>Ki·ªÉm tra Console (F12) ƒë·ªÉ xem n·ªôi dung chi ti·∫øt</small>
                            </div>`,
                            'success'
                        );
                    } else {
                        showStatus(`‚ùå [TEST] ${testNames[testType]} - Th·∫•t b·∫°i`, 'error');
                        showTestResults(
                            `<div class="test-result-item error">
                                <strong>‚ùå ${testNames[testType]} - Th·∫•t b·∫°i</strong><br>
                                <small>${result?.error || 'Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c l·ªói'}</small>
                            </div>`,
                            'error'
                        );
                    }
                } catch (error) {
                    showStatus(`‚ùå [TEST] ${testNames[testType]} - L·ªói: ${error.message}`, 'error');
                    showTestResults(
                        `<div class="test-result-item error">
                            <strong>‚ùå ${testNames[testType]} - L·ªói</strong><br>
                            <small>${error.message}</small>
                        </div>`,
                        'error'
                    );
                }
            }

            // H√†m hi·ªÉn th·ªã k·∫øt qu·∫£ test
            function showTestResults(content, type) {
                const resultsDiv = document.getElementById('testResults');
                const resultsContent = document.getElementById('testResultsContent');
                
                if (content) {
                    resultsContent.innerHTML = content;
                    resultsDiv.style.display = 'block';
                } else {
                    resultsDiv.style.display = 'none';
                }
            }
        });

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status-info ' + type;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                if (type === 'success' || type === 'error') {
                    statusDiv.style.display = 'none';
                }
            }, 5000);
        }

        function renderChatIds(chatIds) {
            const container = document.getElementById('chatIdsContainer');
            container.innerHTML = '';
            
            if (chatIds.length === 0) {
                addChatIdInput('');
            } else {
                chatIds.forEach(chatId => {
                    addChatIdInput(chatId);
                });
            }
        }

        function addChatIdInput(value = '') {
            const container = document.getElementById('chatIdsContainer');
            const div = document.createElement('div');
            div.className = 'chat-id-item';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = '123456789 ho·∫∑c -1001234567890 (nh√≥m)';
            input.value = value;
            input.required = container.children.length === 0; // Ch·ªâ input ƒë·∫ßu ti√™n l√† required
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = 'X√≥a';
            removeBtn.onclick = function() {
                if (container.children.length > 1) {
                    div.remove();
                    updateRequiredFields();
                } else {
                    showStatus('Ph·∫£i c√≥ √≠t nh·∫•t m·ªôt Chat ID!', 'error');
                }
            };
            
            div.appendChild(input);
            div.appendChild(removeBtn);
            container.appendChild(div);
        }

        function getAllChatIds() {
            const container = document.getElementById('chatIdsContainer');
            const inputs = container.querySelectorAll('input');
            return Array.from(inputs).map(input => input.value.trim()).filter(id => id);
        }

        function updateRequiredFields() {
            const container = document.getElementById('chatIdsContainer');
            const inputs = container.querySelectorAll('input');
            inputs.forEach((input, index) => {
                input.required = index === 0;
            });
        }
    </script>
</body>
</html>

